"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.logFailure = exports.buildRequest = exports.buildSource = exports.httpsRequest = void 0;
const https = require("https");
const crypto = require("crypto");
function httpsRequest(params, requestParams) {
    return new Promise((resolve, reject) => {
        var request = https.request(requestParams, (res) => {
            if (res.statusCode < 200 || res.statusCode >= 300) {
                return reject(new Error('statusCode=' + res.statusCode));
            }
            var responseBody = '';
            res.on('data', function (chunk) {
                responseBody += chunk;
            });
            res.on('end', function () {
                try {
                    var info = JSON.parse(responseBody);
                    var failedItems;
                    var success;
                    var error;
                    if (res.statusCode >= 200 && res.statusCode < 299) {
                        failedItems = info.items.filter(function (x) {
                            return x.index.status >= 300;
                        });
                        success = {
                            "attemptedItems": info.items.length,
                            "successfulItems": info.items.length - failedItems.length,
                            "failedItems": failedItems.length
                        };
                        console.log(success);
                    }
                    if (res.statusCode !== 200 || info.errors === true) {
                        // prevents logging of failed entries, but allows logging
                        // of other errors such as access restrictions
                        delete info.items;
                        error = {
                            params: params,
                            statusCode: res.statusCode,
                            failedItems: failedItems,
                            responseBody: info
                        };
                    }
                    if (failedItems.length > 0) {
                        logFailure(error, failedItems);
                    }
                }
                catch (e) {
                    reject(e);
                }
                resolve(responseBody);
            });
        });
        request.on('error', (e) => {
            reject(e.message);
        });
        request.end(requestParams.body);
    });
}
exports.httpsRequest = httpsRequest;
function buildRequest(endpoint, body, _region) {
    if (_region == 'cn-north-1' || _region == 'cn-northwest-1') {
        var endpointParts = endpoint.match(/^([^\.]+)\.?([^\.]*)\.?([^\.]*)\.amazonaws\.com.cn$/);
    }
    else {
        var endpointParts = endpoint.match(/^([^\.]+)\.?([^\.]*)\.?([^\.]*)\.amazonaws\.com$/);
    }
    var region = endpointParts[2];
    var service = endpointParts[3];
    var datetime = (new Date()).toISOString().replace(/[:\-]|\.\d{3}/g, '');
    var date = datetime.substr(0, 8);
    var kDate = hmac('AWS4' + process.env.AWS_SECRET_ACCESS_KEY, date);
    var kRegion = hmac(kDate, region);
    var kService = hmac(kRegion, service);
    var kSigning = hmac(kService, 'aws4_request');
    var request = {
        host: endpoint,
        method: 'POST',
        path: '/_bulk',
        body: body,
        headers: {
            'Content-Type': 'application/json',
            'Host': endpoint,
            'Content-Length': Buffer.byteLength(body),
            'X-Amz-Security-Token': process.env.AWS_SESSION_TOKEN,
            'X-Amz-Date': datetime
        }
    };
    var canonicalHeaders = Object.keys(request.headers)
        .sort(function (a, b) { return a.toLowerCase() < b.toLowerCase() ? -1 : 1; })
        .map(function (k) { return k.toLowerCase() + ':' + request.headers[k]; })
        .join('\n');
    var signedHeaders = Object.keys(request.headers)
        .map(function (k) { return k.toLowerCase(); })
        .sort()
        .join(';');
    var canonicalString = [
        request.method,
        request.path, '',
        canonicalHeaders, '',
        signedHeaders,
        hash(request.body, 'hex'),
    ].join('\n');
    var credentialString = [date, region, service, 'aws4_request'].join('/');
    var stringToSign = [
        'AWS4-HMAC-SHA256',
        datetime,
        credentialString,
        hash(canonicalString, 'hex')
    ].join('\n');
    request.headers.Authorization = [
        'AWS4-HMAC-SHA256 Credential=' + process.env.AWS_ACCESS_KEY_ID + '/' + credentialString,
        'SignedHeaders=' + signedHeaders,
        'Signature=' + hmac(kSigning, stringToSign, 'hex')
    ].join(', ');
    return request;
}
exports.buildRequest = buildRequest;
function hmac(key, str, encoding = null) {
    return crypto.createHmac('sha256', key).update(str, 'utf8').digest(encoding);
}
function hash(str, encoding) {
    return crypto.createHash('sha256').update(str, 'utf8').digest(encoding);
}
function buildSource(message) {
    var jsonSubString = extractJson(message);
    if (jsonSubString !== null) {
        return JSON.parse(jsonSubString);
    }
    return {};
}
exports.buildSource = buildSource;
function extractJson(message) {
    message = JSON.stringify(message);
    try {
        var jsonStart = message.indexOf('{');
    }
    catch (e) {
        console.log('extractJson error:', e);
        return null;
    }
    if (jsonStart < 0)
        return null;
    var jsonSubString = message.substring(jsonStart);
    return isValidJson(jsonSubString) ? jsonSubString : null;
}
function isValidJson(message) {
    try {
        JSON.parse(message);
    }
    catch (e) {
        return false;
    }
    return true;
}
function logFailure(error, failedItems) {
    console.log('Error::::---------- ' + JSON.stringify(error, null, 2));
    if (failedItems && failedItems.length > 0) {
        console.log("Failed Items: " +
            JSON.stringify(failedItems, null, 2));
    }
}
exports.logFailure = logFailure;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tbW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY29tbW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLCtCQUFnQztBQUNoQyxpQ0FBa0M7QUFFbEMsU0FBUyxZQUFZLENBQUMsTUFBVyxFQUFFLGFBQWtCO0lBQ2pELE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7UUFDbkMsSUFBSSxPQUFPLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxhQUFhLEVBQUUsQ0FBQyxHQUFRLEVBQUUsRUFBRTtZQUNwRCxJQUFJLEdBQUcsQ0FBQyxVQUFVLEdBQUcsR0FBRyxJQUFJLEdBQUcsQ0FBQyxVQUFVLElBQUksR0FBRyxFQUFFO2dCQUMvQyxPQUFPLE1BQU0sQ0FBQyxJQUFJLEtBQUssQ0FBQyxhQUFhLEdBQUcsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7YUFDNUQ7WUFDRCxJQUFJLFlBQVksR0FBRyxFQUFFLENBQUM7WUFDdEIsR0FBRyxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsVUFBVSxLQUFVO2dCQUMvQixZQUFZLElBQUksS0FBSyxDQUFDO1lBQzFCLENBQUMsQ0FBQyxDQUFDO1lBQ0gsR0FBRyxDQUFDLEVBQUUsQ0FBQyxLQUFLLEVBQUU7Z0JBQ1YsSUFBSTtvQkFDQSxJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxDQUFDO29CQUNwQyxJQUFJLFdBQWdCLENBQUM7b0JBQ3JCLElBQUksT0FBWSxDQUFDO29CQUNqQixJQUFJLEtBQVUsQ0FBQztvQkFFZixJQUFJLEdBQUcsQ0FBQyxVQUFXLElBQUksR0FBRyxJQUFJLEdBQUcsQ0FBQyxVQUFXLEdBQUcsR0FBRyxFQUFFO3dCQUNqRCxXQUFXLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFrQzs0QkFDeEUsT0FBTyxDQUFDLENBQUMsS0FBSyxDQUFDLE1BQU0s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QUMsTUFBTSxHQUFHLENBQUMsRUFBRTtRQUN2QyxPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFnQjtZQUN4QixJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUM3QztBQUNMLENBQUM7QUFFaUQsZ0NBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgaHR0cHMgPSByZXF1aXJlKCdodHRwcycpO1xuaW1wb3J0IGNyeXB0byA9IHJlcXVpcmUoJ2NyeXB0bycpO1xuXG5mdW5jdGlvbiBodHRwc1JlcXVlc3QocGFyYW1zOiBhbnksIHJlcXVlc3RQYXJhbXM6IGFueSkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIHZhciByZXF1ZXN0ID0gaHR0cHMucmVxdWVzdChyZXF1ZXN0UGFyYW1zLCAocmVzOiBhbnkpID0+IHtcbiAgICAgICAgICAgIGlmIChyZXMuc3RhdHVzQ29kZSA8IDIwMCB8fCByZXMuc3RhdHVzQ29kZSA+PSAzMDApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVqZWN0KG5ldyBFcnJvcignc3RhdHVzQ29kZT0nICsgcmVzLnN0YXR1c0NvZGUpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciByZXNwb25zZUJvZHkgPSAnJztcbiAgICAgICAgICAgIHJlcy5vbignZGF0YScsIGZ1bmN0aW9uIChjaHVuazogYW55KSB7XG4gICAgICAgICAgICAgICAgcmVzcG9uc2VCb2R5ICs9IGNodW5rO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXMub24oJ2VuZCcsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgaW5mbyA9IEpTT04ucGFyc2UocmVzcG9uc2VCb2R5KTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGZhaWxlZEl0ZW1zOiBhbnk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBzdWNjZXNzOiBhbnk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBlcnJvcjogYW55O1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChyZXMuc3RhdHVzQ29kZSEgPj0gMjAwICYmIHJlcy5zdGF0dXNDb2RlISA8IDI5OSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkSXRlbXMgPSBpbmZvLml0ZW1zLmZpbHRlcihmdW5jdGlvbiAoeDogeyBpbmRleDogeyBzdGF0dXM6IG51bWJlcjsgfTsgfSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB4LmluZGV4LnN0YXR1cyA+PSAzMDA7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgc3VjY2VzcyA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcImF0dGVtcHRlZEl0ZW1zXCI6IGluZm8uaXRlbXMubGVuZ3RoLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwic3VjY2Vzc2Z1bEl0ZW1zXCI6IGluZm8uaXRlbXMubGVuZ3RoIC0gZmFpbGVkSXRlbXMubGVuZ3RoLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiZmFpbGVkSXRlbXNcIjogZmFpbGVkSXRlbXMubGVuZ3RoXG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coc3VjY2Vzcyk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBpZiAocmVzLnN0YXR1c0NvZGUgIT09IDIwMCB8fCBpbmZvLmVycm9ycyA9PT0gdHJ1ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gcHJldmVudHMgbG9nZ2luZyBvZiBmYWlsZWQgZW50cmllcywgYnV0IGFsbG93cyBsb2dnaW5nXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBvZiBvdGhlciBlcnJvcnMgc3VjaCBhcyBhY2Nlc3MgcmVzdHJpY3Rpb25zXG4gICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgaW5mby5pdGVtcztcbiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtczogcGFyYW1zLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1c0NvZGU6IHJlcy5zdGF0dXNDb2RlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZEl0ZW1zOiBmYWlsZWRJdGVtcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZUJvZHk6IGluZm9cbiAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKGZhaWxlZEl0ZW1zLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ0ZhaWx1cmUoZXJyb3IsIGZhaWxlZEl0ZW1zKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXNvbHZlKHJlc3BvbnNlQm9keSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmVxdWVzdC5vbignZXJyb3InLCAoZSkgPT4ge1xuICAgICAgICAgICAgcmVqZWN0KGUubWVzc2FnZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJlcXVlc3QuZW5kKHJlcXVlc3RQYXJhbXMuYm9keSk7XG4gICAgfSk7XG59XG5cblxuZnVuY3Rpb24gYnVpbGRSZXF1ZXN0KGVuZHBvaW50OiBhbnksIGJvZHk6IGFueSwgX3JlZ2lvbjogc3RyaW5nKSB7XG5cbiAgICBpZiAoX3JlZ2lvbiA9PSAnY24tbm9ydGgtMScgfHwgX3JlZ2lvbiA9PSAnY24tbm9ydGh3ZXN0LTEnKSB7XG4gICAgICAgIHZhciBlbmRwb2ludFBhcnRzID0gZW5kcG9pbnQubWF0Y2goL14oW15cXC5dKylcXC4/KFteXFwuXSopXFwuPyhbXlxcLl0qKVxcLmFtYXpvbmF3c1xcLmNvbS5jbiQvKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICB2YXIgZW5kcG9pbnRQYXJ0cyA9IGVuZHBvaW50Lm1hdGNoKC9eKFteXFwuXSspXFwuPyhbXlxcLl0qKVxcLj8oW15cXC5dKilcXC5hbWF6b25hd3NcXC5jb20kLyk7XG4gICAgfVxuICAgIHZhciByZWdpb24gPSBlbmRwb2ludFBhcnRzWzJdO1xuICAgIHZhciBzZXJ2aWNlID0gZW5kcG9pbnRQYXJ0c1szXTtcbiAgICB2YXIgZGF0ZXRpbWUgPSAobmV3IERhdGUoKSkudG9JU09TdHJpbmcoKS5yZXBsYWNlKC9bOlxcLV18XFwuXFxkezN9L2csICcnKTtcbiAgICB2YXIgZGF0ZSA9IGRhdGV0aW1lLnN1YnN0cigwLCA4KTtcbiAgICB2YXIga0RhdGUgPSBobWFjKCdBV1M0JyArIHByb2Nlc3MuZW52LkFXU19TRUNSRVRfQUNDRVNTX0tFWSwgZGF0ZSk7XG4gICAgdmFyIGtSZWdpb24gPSBobWFjKGtEYXRlLCByZWdpb24pO1xuICAgIHZhciBrU2VydmljZSA9IGhtYWMoa1JlZ2lvbiwgc2VydmljZSk7XG4gICAgdmFyIGtTaWduaW5nID0gaG1hYyhrU2VydmljZSwgJ2F3czRfcmVxdWVzdCcpO1xuXG4gICAgdmFyIHJlcXVlc3QgPSB7XG4gICAgICAgIGhvc3Q6IGVuZHBvaW50LFxuICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgcGF0aDogJy9fYnVsaycsXG4gICAgICAgIGJvZHk6IGJvZHksXG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICAgICAnSG9zdCc6IGVuZHBvaW50LFxuICAgICAgICAgICAgJ0NvbnRlbnQtTGVuZ3RoJzogQnVmZmVyLmJ5dGVMZW5ndGgoYm9keSksXG4gICAgICAgICAgICAnWC1BbXotU2VjdXJpdHktVG9rZW4nOiBwcm9jZXNzLmVudi5BV1NfU0VTU0lPTl9UT0tFTixcbiAgICAgICAgICAgICdYLUFtei1EYXRlJzogZGF0ZXRpbWVcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBpbnRlcmZhY2UgSVJlcXVlc3RIZWFkZXIge1xuICAgICAgICBba2V5OiBzdHJpbmddOiBhbnlcbiAgICB9XG5cbiAgICBpbnRlcmZhY2UgSVJlcXVlc3RIZWFkZXJBdXRob3JpemF0aW9uIHtcbiAgICAgICAgW2tleTogc3RyaW5nXTogYW55XG4gICAgfVxuXG4gICAgdmFyIGNhbm9uaWNhbEhlYWRlcnMgPSBPYmplY3Qua2V5cyhyZXF1ZXN0LmhlYWRlcnMpXG4gICAgICAgIC5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7IHJldHVybiBhLnRvTG93ZXJDYXNlKCkgPCBiLnRvTG93ZXJDYXNlKCkgPyAtMSA6IDE7IH0pXG4gICAgICAgIC5tYXAoZnVuY3Rpb24gKGspIHsgcmV0dXJuIGsudG9Mb3dlckNhc2UoKSArICc6JyArICg8SVJlcXVlc3RIZWFkZXI+cmVxdWVzdC5oZWFkZXJzKVtrXTsgfSlcbiAgICAgICAgLmpvaW4oJ1xcbicpO1xuXG4gICAgdmFyIHNpZ25lZEhlYWRlcnMgPSBPYmplY3Qua2V5cyhyZXF1ZXN0LmhlYWRlcnMpXG4gICAgICAgIC5tYXAoZnVuY3Rpb24gKGspIHsgcmV0dXJuIGsudG9Mb3dlckNhc2UoKTsgfSlcbiAgICAgICAgLnNvcnQoKVxuICAgICAgICAuam9pbignOycpO1xuXG4gICAgdmFyIGNhbm9uaWNhbFN0cmluZyA9IFtcbiAgICAgICAgcmVxdWVzdC5tZXRob2QsXG4gICAgICAgIHJlcXVlc3QucGF0aCwgJycsXG4gICAgICAgIGNhbm9uaWNhbEhlYWRlcnMsICcnLFxuICAgICAgICBzaWduZWRIZWFkZXJzLFxuICAgICAgICBoYXNoKHJlcXVlc3QuYm9keSwgJ2hleCcpLFxuICAgIF0uam9pbignXFxuJyk7XG5cbiAgICB2YXIgY3JlZGVudGlhbFN0cmluZyA9IFtkYXRlLCByZWdpb24sIHNlcnZpY2UsICdhd3M0X3JlcXVlc3QnXS5qb2luKCcvJyk7XG5cbiAgICB2YXIgc3RyaW5nVG9TaWduID0gW1xuICAgICAgICAnQVdTNC1ITUFDLVNIQTI1NicsXG4gICAgICAgIGRhdGV0aW1lLFxuICAgICAgICBjcmVkZW50aWFsU3RyaW5nLFxuICAgICAgICBoYXNoKGNhbm9uaWNhbFN0cmluZywgJ2hleCcpXG4gICAgXS5qb2luKCdcXG4nKTtcblxuICAgICg8SVJlcXVlc3RIZWFkZXJBdXRob3JpemF0aW9uPnJlcXVlc3QuaGVhZGVycykuQXV0aG9yaXphdGlvbiA9IFtcbiAgICAgICAgJ0FXUzQtSE1BQy1TSEEyNTYgQ3JlZGVudGlhbD0nICsgcHJvY2Vzcy5lbnYuQVdTX0FDQ0VTU19LRVlfSUQgKyAnLycgKyBjcmVkZW50aWFsU3RyaW5nLFxuICAgICAgICAnU2lnbmVkSGVhZGVycz0nICsgc2lnbmVkSGVhZGVycyxcbiAgICAgICAgJ1NpZ25hdHVyZT0nICsgaG1hYyhrU2lnbmluZywgc3RyaW5nVG9TaWduLCAnaGV4JylcbiAgICBdLmpvaW4oJywgJyk7XG5cbiAgICByZXR1cm4gcmVxdWVzdDtcbn1cblxuZnVuY3Rpb24gaG1hYyhrZXk6IGFueSwgc3RyOiBhbnksIGVuY29kaW5nOiBhbnkgPSBudWxsKSB7XG4gICAgcmV0dXJuIGNyeXB0by5jcmVhdGVIbWFjKCdzaGEyNTYnLCBrZXkpLnVwZGF0ZShzdHIsICd1dGY4JykuZGlnZXN0KGVuY29kaW5nKTtcbn1cblxuZnVuY3Rpb24gaGFzaChzdHI6IGFueSwgZW5jb2Rpbmc6IGFueSkge1xuICAgIHJldHVybiBjcnlwdG8uY3JlYXRlSGFzaCgnc2hhMjU2JykudXBkYXRlKHN0ciwgJ3V0ZjgnKS5kaWdlc3QoZW5jb2RpbmcpO1xufVxuXG5mdW5jdGlvbiBidWlsZFNvdXJjZShtZXNzYWdlOiBhbnkpIHtcbiAgICB2YXIganNvblN1YlN0cmluZyA9IGV4dHJhY3RKc29uKG1lc3NhZ2UpO1xuICAgIGlmIChqc29uU3ViU3RyaW5nICE9PSBudWxsKSB7XG4gICAgICAgIHJldHVybiBKU09OLnBhcnNlKGpzb25TdWJTdHJpbmcpO1xuICAgIH1cblxuICAgIHJldHVybiB7fTtcbn1cblxuZnVuY3Rpb24gZXh0cmFjdEpzb24obWVzc2FnZTogYW55KSB7XG4gICAgbWVzc2FnZSA9IEpTT04uc3RyaW5naWZ5KG1lc3NhZ2UpO1xuICAgIHRyeSB7XG4gICAgICAgIHZhciBqc29uU3RhcnQgPSBtZXNzYWdlLmluZGV4T2YoJ3snKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdleHRyYWN0SnNvbiBlcnJvcjonLCBlKTtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgaWYgKGpzb25TdGFydCA8IDApIHJldHVybiBudWxsO1xuICAgIHZhciBqc29uU3ViU3RyaW5nID0gbWVzc2FnZS5zdWJzdHJpbmcoanNvblN0YXJ0KTtcbiAgICByZXR1cm4gaXNWYWxpZEpzb24oanNvblN1YlN0cmluZykgPyBqc29uU3ViU3RyaW5nIDogbnVsbDtcbn1cblxuZnVuY3Rpb24gaXNWYWxpZEpzb24obWVzc2FnZTogYW55KSB7XG4gICAgdHJ5IHtcbiAgICAgICAgSlNPTi5wYXJzZShtZXNzYWdlKTtcbiAgICB9IGNhdGNoIChlKSB7IHJldHVybiBmYWxzZTsgfVxuICAgIHJldHVybiB0cnVlO1xufVxuXG5mdW5jdGlvbiBsb2dGYWlsdXJlKGVycm9yOiBhbnksIGZhaWxlZEl0ZW1zOiBhbnkpIHtcbiAgICBjb25zb2xlLmxvZygnRXJyb3I6Ojo6LS0tLS0tLS0tLSAnICsgSlNPTi5zdHJpbmdpZnkoZXJyb3IsIG51bGwsIDIpKTtcblxuICAgIGlmIChmYWlsZWRJdGVtcyAmJiBmYWlsZWRJdGVtcy5sZW5ndGggPiAwKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiRmFpbGVkIEl0ZW1zOiBcIiArXG4gICAgICAgICAgICBKU09OLnN0cmluZ2lmeShmYWlsZWRJdGVtcywgbnVsbCwgMikpO1xuICAgIH1cbn1cblxuZXhwb3J0IHsgaHR0cHNSZXF1ZXN0LCBidWlsZFNvdXJjZSwgYnVpbGRSZXF1ZXN0LCBsb2dGYWlsdXJlIH0iXX0=