"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.logFailure = exports.buildRequest = exports.buildSource = exports.httpsRequest = void 0;
const https = require("https");
const crypto = require("crypto");
const AWS = require("aws-sdk");
function httpsRequest(requestParams, logsData, logFileKey) {
    return new Promise((resolve, reject) => {
        var request = https.request(requestParams, (res) => {
            if (res.statusCode < 200 || res.statusCode >= 300) {
                return reject(new Error('statusCode=' + res.statusCode));
            }
            var responseBody = '';
            res.on('data', function (chunk) {
                responseBody += chunk;
            });
            res.on('end', async function () {
                try {
                    var info = JSON.parse(responseBody);
                    var failedItems;
                    var success;
                    var error;
                    var failedLogs = {
                        Records: []
                    };
                    for (var i = 0; i < info.items.length; i++) {
                        if (info.items[i].index.status >= 300) {
                            if (process.env.LOG_TYPE == 'CloudTrail') {
                                failedLogs.Records.push(logsData.Records[i]);
                            }
                            else if (process.env.LOG_TYPE == 'S3Access') {
                                const dataArray = logsData.split("\n");
                                failedLogs.Records.push(dataArray[i]);
                            }
                        }
                    }
                    if (res.statusCode >= 200 && res.statusCode < 299) {
                        failedItems = info.items.filter(function (x) {
                            return x.index.status >= 300;
                        });
                        success = {
                            "attemptedItems": info.items.length,
                            "successfulItems": info.items.length - failedItems.length,
                            "failedItems": failedItems.length
                        };
                        console.log(success);
                    }
                    if (res.statusCode !== 200 || info.errors === true) {
                        // prevents logging of failed entries, but allows logging
                        // of other errors such as access restrictions
                        delete info.items;
                        error = {
                            statusCode: res.statusCode,
                            failedItems: failedItems,
                            responseBody: info
                        };
                    }
                    if (failedItems.length > 0) {
                        logFailure(error, failedItems);
                        var failedLogsContent = JSON.stringify(failedLogs);
                        var endIndex = logFileKey.length - 8;
                        const failedLogsKey = process.env.DOMAIN_NAME + '/' + process.env.LOG_TYPE + '/'
                            + logFileKey.substr(0, endIndex) + '_' + failedItems.length.toString() + '_failed.json';
                        await putObjectToS3(failedLogsContent, process.env.FAILED_LOG_BUCKET_NAME, failedLogsKey);
                    }
                }
                catch (e) {
                    reject(e);
                }
                resolve(responseBody);
            });
        });
        request.on('error', (e) => {
            reject(e.message);
        });
        request.end(requestParams.body);
    });
}
exports.httpsRequest = httpsRequest;
function buildRequest(endpoint, body, _region) {
    if (_region == 'cn-north-1' || _region == 'cn-northwest-1') {
        var endpointParts = endpoint.match(/^([^\.]+)\.?([^\.]*)\.?([^\.]*)\.amazonaws\.com.cn$/);
    }
    else {
        var endpointParts = endpoint.match(/^([^\.]+)\.?([^\.]*)\.?([^\.]*)\.amazonaws\.com$/);
    }
    var region = endpointParts[2];
    var service = endpointParts[3];
    var datetime = (new Date()).toISOString().replace(/[:\-]|\.\d{3}/g, '');
    var date = datetime.substr(0, 8);
    var kDate = hmac('AWS4' + process.env.AWS_SECRET_ACCESS_KEY, date);
    var kRegion = hmac(kDate, region);
    var kService = hmac(kRegion, service);
    var kSigning = hmac(kService, 'aws4_request');
    var request = {
        host: endpoint,
        method: 'POST',
        path: '/_bulk',
        body: body,
        headers: {
            'Content-Type': 'application/json',
            'Host': endpoint,
            'Content-Length': Buffer.byteLength(body),
            'X-Amz-Security-Token': process.env.AWS_SESSION_TOKEN,
            'X-Amz-Date': datetime
        }
    };
    var canonicalHeaders = Object.keys(request.headers)
        .sort(function (a, b) { return a.toLowerCase() < b.toLowerCase() ? -1 : 1; })
        .map(function (k) { return k.toLowerCase() + ':' + request.headers[k]; })
        .join('\n');
    var signedHeaders = Object.keys(request.headers)
        .map(function (k) { return k.toLowerCase(); })
        .sort()
        .join(';');
    var canonicalString = [
        request.method,
        request.path, '',
        canonicalHeaders, '',
        signedHeaders,
        hash(request.body, 'hex'),
    ].join('\n');
    var credentialString = [date, region, service, 'aws4_request'].join('/');
    var stringToSign = [
        'AWS4-HMAC-SHA256',
        datetime,
        credentialString,
        hash(canonicalString, 'hex')
    ].join('\n');
    request.headers.Authorization = [
        'AWS4-HMAC-SHA256 Credential=' + process.env.AWS_ACCESS_KEY_ID + '/' + credentialString,
        'SignedHeaders=' + signedHeaders,
        'Signature=' + hmac(kSigning, stringToSign, 'hex')
    ].join(', ');
    return request;
}
exports.buildRequest = buildRequest;
/**
 * This function used to write file to S3 bucket
 * @param data
 * @param bucket
 * @param key
 */
function putObjectToS3(data, bucket, key) {
    return new Promise(async (resolve) => {
        var s3 = new AWS.S3();
        var params = {
            Bucket: bucket,
            Key: key,
            Body: data
        };
        await s3.putObject(params, function (err) {
            if (err)
                console.log(err, err.stack);
            else
                console.log("Put failed injection logs to s3 Bucket:" + bucket + ":" + key);
        }).promise();
        resolve();
    });
}
function hmac(key, str, encoding = null) {
    return crypto.createHmac('sha256', key).update(str, 'utf8').digest(encoding);
}
function hash(str, encoding) {
    return crypto.createHash('sha256').update(str, 'utf8').digest(encoding);
}
function buildSource(message) {
    var jsonSubString = extractJson(message);
    if (jsonSubString !== null) {
        return JSON.parse(jsonSubString);
    }
    return {};
}
exports.buildSource = buildSource;
function extractJson(message) {
    message = JSON.stringify(message);
    try {
        var jsonStart = message.indexOf('{');
    }
    catch (e) {
        console.log('extractJson error:', e);
        return null;
    }
    if (jsonStart < 0)
        return null;
    var jsonSubString = message.substring(jsonStart);
    return isValidJson(jsonSubString) ? jsonSubString : null;
}
function isValidJson(message) {
    try {
        JSON.parse(message);
    }
    catch (e) {
        return false;
    }
    return true;
}
function logFailure(error, failedItems) {
    console.log('Error::::---------- ' + JSON.stringify(error, null, 2));
    if (failedItems && failedItems.length > 0) {
        console.log("Failed Items: " +
            JSON.stringify(failedItems, null, 2));
    }
}
exports.logFailure = logFailure;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tbW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY29tbW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLCtCQUFnQztBQUNoQyxpQ0FBa0M7QUFDbEMsK0JBQWdDO0FBRWhDLFNBQVMsWUFBWSxDQUFDLGFBQWtCLEVBQUUsUUFBYyxFQUFFLFVBQWdCO0lBQ3RFLE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7UUFDbkMsSUFBSSxPQUFPLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxhQUFhLEVBQUUsQ0FBQyxHQUFRLEVBQUUsRUFBRTtZQUNwRCxJQUFJLEdBQUcsQ0FBQyxVQUFVLEdBQUcsR0FBRyxJQUFJLEdBQUcsQ0FBQyxVQUFVLElBQUksR0FBRyxFQUFFO2dCQUMvQyxPQUFPLE1BQU0sQ0FBQyxJQUFJLEtBQUssQ0FBQyxhQUFhLEdBQUcsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7YUFDNUQ7WUFDRCxJQUFJLFlBQVksR0FBRyxFQUFFLENBQUM7WUFDdEIsR0FBRyxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsVUFBVSxLQUFVO2dCQUMvQixZQUFZLElBQUksS0FBSyxDQUFDO1lBQzFCLENBQUMsQ0FBQyxDQUFDO1lBQ0gsR0FBRyxDQUFDLEVBQUUsQ0FBQyxLQUFLLEVBQUUsS0FBSztnQkFDZixJQUFJO29CQUNBLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLENBQUM7b0JBQ3BDLElBQUksV0FBZ0IsQ0FBQztvQkFDckIsSUFBSSxPQUFZLENBQUM7b0JBQ2pCLElBQUksS0FBVSxDQUFDO29CQUNmLElBQUksVUFBVSxHQUFHO3dCQUNiLE9BQU8sRUFBRSxFQUFTO3FCQUNyQixDQUFDO29CQUNGLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVB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QUFDLEVBQUU7UUFDUixPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQixFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3JDLE9BQU8sSUFBSSxDQUFDO0tBQ2Y7SUFFRCxJQUFJLFNBQVMsR0FBRyxDQUFDO1FBQUUsT0FBTyxJQUFJLENBQUM7SUFDL0IsSUFBSSxhQUFhLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUNqRCxPQUFPLFdBQVcsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7QUFDN0QsQ0FBQztBQUVELFNBQVMsV0FBVyxDQUFDLE9BQVk7SUFDN0IsSUFBSTtRQUNBLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7S0FDdkI7SUFBQyxPQUFPLENBQUMsRUFBRTtRQUFFLE9BQU8sS0FBSyxDQUFDO0tBQUU7SUFDN0IsT0FBTyxJQUFJLENBQUM7QUFDaEIsQ0FBQztBQUVELFNBQVMsVUFBVSxDQUFDLEtBQVUsRUFBRSxXQUFnQjtJQUM1QyxPQUFPLENBQUMsR0FBRyxDQUFDLHNCQUFzQixHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRXJFLElBQUksV0FBVyxJQUFJLFdBQVcsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1FBQ3ZDLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCO1lBQ3hCLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQzdDO0FBQ0wsQ0FBQztBQUVpRCxnQ0FBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBodHRwcyA9IHJlcXVpcmUoJ2h0dHBzJyk7XG5pbXBvcnQgY3J5cHRvID0gcmVxdWlyZSgnY3J5cHRvJyk7XG5pbXBvcnQgQVdTID0gcmVxdWlyZSgnYXdzLXNkaycpO1xuXG5mdW5jdGlvbiBodHRwc1JlcXVlc3QocmVxdWVzdFBhcmFtczogYW55LCBsb2dzRGF0YT86IGFueSwgbG9nRmlsZUtleT86IGFueSkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIHZhciByZXF1ZXN0ID0gaHR0cHMucmVxdWVzdChyZXF1ZXN0UGFyYW1zLCAocmVzOiBhbnkpID0+IHtcbiAgICAgICAgICAgIGlmIChyZXMuc3RhdHVzQ29kZSA8IDIwMCB8fCByZXMuc3RhdHVzQ29kZSA+PSAzMDApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVqZWN0KG5ldyBFcnJvcignc3RhdHVzQ29kZT0nICsgcmVzLnN0YXR1c0NvZGUpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciByZXNwb25zZUJvZHkgPSAnJztcbiAgICAgICAgICAgIHJlcy5vbignZGF0YScsIGZ1bmN0aW9uIChjaHVuazogYW55KSB7XG4gICAgICAgICAgICAgICAgcmVzcG9uc2VCb2R5ICs9IGNodW5rO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXMub24oJ2VuZCcsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgaW5mbyA9IEpTT04ucGFyc2UocmVzcG9uc2VCb2R5KTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGZhaWxlZEl0ZW1zOiBhbnk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBzdWNjZXNzOiBhbnk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBlcnJvcjogYW55O1xuICAgICAgICAgICAgICAgICAgICB2YXIgZmFpbGVkTG9ncyA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIFJlY29yZHM6IFtdIGFzIGFueVxuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGluZm8uaXRlbXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbmZvLml0ZW1zW2ldLmluZGV4LnN0YXR1cyA+PSAzMDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihwcm9jZXNzLmVudi5MT0dfVFlQRSA9PSAnQ2xvdWRUcmFpbCcpe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWRMb2dzLlJlY29yZHMucHVzaChsb2dzRGF0YS5SZWNvcmRzW2ldKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlIGlmKHByb2Nlc3MuZW52LkxPR19UWVBFID09ICdTM0FjY2Vzcycpe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkYXRhQXJyYXkgPSBsb2dzRGF0YS5zcGxpdChcIlxcblwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkTG9ncy5SZWNvcmRzLnB1c2goZGF0YUFycmF5W2ldKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGlmIChyZXMuc3RhdHVzQ29kZSEgPj0gMjAwICYmIHJlcy5zdGF0dXNDb2RlISA8IDI5OSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkSXRlbXMgPSBpbmZvLml0ZW1zLmZpbHRlcihmdW5jdGlvbiAoeDogeyBpbmRleDogeyBzdGF0dXM6IG51bWJlcjsgfTsgfSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB4LmluZGV4LnN0YXR1cyA+PSAzMDA7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgc3VjY2VzcyA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcImF0dGVtcHRlZEl0ZW1zXCI6IGluZm8uaXRlbXMubGVuZ3RoLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwic3VjY2Vzc2Z1bEl0ZW1zXCI6IGluZm8uaXRlbXMubGVuZ3RoIC0gZmFpbGVkSXRlbXMubGVuZ3RoLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiZmFpbGVkSXRlbXNcIjogZmFpbGVkSXRlbXMubGVuZ3RoXG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coc3VjY2Vzcyk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBpZiAocmVzLnN0YXR1c0NvZGUgIT09IDIwMCB8fCBpbmZvLmVycm9ycyA9PT0gdHJ1ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gcHJldmVudHMgbG9nZ2luZyBvZiBmYWlsZWQgZW50cmllcywgYnV0IGFsbG93cyBsb2dnaW5nXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBvZiBvdGhlciBlcnJvcnMgc3VjaCBhcyBhY2Nlc3MgcmVzdHJpY3Rpb25zXG4gICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgaW5mby5pdGVtcztcbiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1c0NvZGU6IHJlcy5zdGF0dXNDb2RlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZEl0ZW1zOiBmYWlsZWRJdGVtcyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZUJvZHk6IGluZm9cbiAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKGZhaWxlZEl0ZW1zLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ0ZhaWx1cmUoZXJyb3IsIGZhaWxlZEl0ZW1zKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBmYWlsZWRMb2dzQ29udGVudCA9IEpTT04uc3RyaW5naWZ5KGZhaWxlZExvZ3MpOyBcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBlbmRJbmRleCA9IGxvZ0ZpbGVLZXkubGVuZ3RoIC0gODtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZhaWxlZExvZ3NLZXkgPSBwcm9jZXNzLmVudi5ET01BSU5fTkFNRSArICcvJyArIHByb2Nlc3MuZW52LkxPR19UWVBFICsgJy8nIFxuICAgICAgICAgICAgICAgICAgICAgICAgKyBsb2dGaWxlS2V5LnN1YnN0cigwLCBlbmRJbmRleCkgKyAnXycgKyBmYWlsZWRJdGVtcy5sZW5ndGgudG9TdHJpbmcoKSArICdfZmFpbGVkLmpzb24nO1xuICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgcHV0T2JqZWN0VG9TMyhmYWlsZWRMb2dzQ29udGVudCwgcHJvY2Vzcy5lbnYuRkFJTEVEX0xPR19CVUNLRVRfTkFNRSwgZmFpbGVkTG9nc0tleSlcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXNvbHZlKHJlc3BvbnNlQm9keSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmVxdWVzdC5vbignZXJyb3InLCAoZSkgPT4ge1xuICAgICAgICAgICAgcmVqZWN0KGUubWVzc2FnZSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJlcXVlc3QuZW5kKHJlcXVlc3RQYXJhbXMuYm9keSk7XG4gICAgfSk7XG59XG5cblxuZnVuY3Rpb24gYnVpbGRSZXF1ZXN0KGVuZHBvaW50OiBhbnksIGJvZHk6IGFueSwgX3JlZ2lvbjogc3RyaW5nKSB7XG5cbiAgICBpZiAoX3JlZ2lvbiA9PSAnY24tbm9ydGgtMScgfHwgX3JlZ2lvbiA9PSAnY24tbm9ydGh3ZXN0LTEnKSB7XG4gICAgICAgIHZhciBlbmRwb2ludFBhcnRzID0gZW5kcG9pbnQubWF0Y2goL14oW15cXC5dKylcXC4/KFteXFwuXSopXFwuPyhbXlxcLl0qKVxcLmFtYXpvbmF3c1xcLmNvbS5jbiQvKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICB2YXIgZW5kcG9pbnRQYXJ0cyA9IGVuZHBvaW50Lm1hdGNoKC9eKFteXFwuXSspXFwuPyhbXlxcLl0qKVxcLj8oW15cXC5dKilcXC5hbWF6b25hd3NcXC5jb20kLyk7XG4gICAgfVxuICAgIHZhciByZWdpb24gPSBlbmRwb2ludFBhcnRzWzJdO1xuICAgIHZhciBzZXJ2aWNlID0gZW5kcG9pbnRQYXJ0c1szXTtcbiAgICB2YXIgZGF0ZXRpbWUgPSAobmV3IERhdGUoKSkudG9JU09TdHJpbmcoKS5yZXBsYWNlKC9bOlxcLV18XFwuXFxkezN9L2csICcnKTtcbiAgICB2YXIgZGF0ZSA9IGRhdGV0aW1lLnN1YnN0cigwLCA4KTtcbiAgICB2YXIga0RhdGUgPSBobWFjKCdBV1M0JyArIHByb2Nlc3MuZW52LkFXU19TRUNSRVRfQUNDRVNTX0tFWSwgZGF0ZSk7XG4gICAgdmFyIGtSZWdpb24gPSBobWFjKGtEYXRlLCByZWdpb24pO1xuICAgIHZhciBrU2VydmljZSA9IGhtYWMoa1JlZ2lvbiwgc2VydmljZSk7XG4gICAgdmFyIGtTaWduaW5nID0gaG1hYyhrU2VydmljZSwgJ2F3czRfcmVxdWVzdCcpO1xuXG4gICAgdmFyIHJlcXVlc3QgPSB7XG4gICAgICAgIGhvc3Q6IGVuZHBvaW50LFxuICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgcGF0aDogJy9fYnVsaycsXG4gICAgICAgIGJvZHk6IGJvZHksXG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICAgICAnSG9zdCc6IGVuZHBvaW50LFxuICAgICAgICAgICAgJ0NvbnRlbnQtTGVuZ3RoJzogQnVmZmVyLmJ5dGVMZW5ndGgoYm9keSksXG4gICAgICAgICAgICAnWC1BbXotU2VjdXJpdHktVG9rZW4nOiBwcm9jZXNzLmVudi5BV1NfU0VTU0lPTl9UT0tFTixcbiAgICAgICAgICAgICdYLUFtei1EYXRlJzogZGF0ZXRpbWVcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBpbnRlcmZhY2UgSVJlcXVlc3RIZWFkZXIge1xuICAgICAgICBba2V5OiBzdHJpbmddOiBhbnlcbiAgICB9XG5cbiAgICBpbnRlcmZhY2UgSVJlcXVlc3RIZWFkZXJBdXRob3JpemF0aW9uIHtcbiAgICAgICAgW2tleTogc3RyaW5nXTogYW55XG4gICAgfVxuXG4gICAgdmFyIGNhbm9uaWNhbEhlYWRlcnMgPSBPYmplY3Qua2V5cyhyZXF1ZXN0LmhlYWRlcnMpXG4gICAgICAgIC5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7IHJldHVybiBhLnRvTG93ZXJDYXNlKCkgPCBiLnRvTG93ZXJDYXNlKCkgPyAtMSA6IDE7IH0pXG4gICAgICAgIC5tYXAoZnVuY3Rpb24gKGspIHsgcmV0dXJuIGsudG9Mb3dlckNhc2UoKSArICc6JyArICg8SVJlcXVlc3RIZWFkZXI+cmVxdWVzdC5oZWFkZXJzKVtrXTsgfSlcbiAgICAgICAgLmpvaW4oJ1xcbicpO1xuXG4gICAgdmFyIHNpZ25lZEhlYWRlcnMgPSBPYmplY3Qua2V5cyhyZXF1ZXN0LmhlYWRlcnMpXG4gICAgICAgIC5tYXAoZnVuY3Rpb24gKGspIHsgcmV0dXJuIGsudG9Mb3dlckNhc2UoKTsgfSlcbiAgICAgICAgLnNvcnQoKVxuICAgICAgICAuam9pbignOycpO1xuXG4gICAgdmFyIGNhbm9uaWNhbFN0cmluZyA9IFtcbiAgICAgICAgcmVxdWVzdC5tZXRob2QsXG4gICAgICAgIHJlcXVlc3QucGF0aCwgJycsXG4gICAgICAgIGNhbm9uaWNhbEhlYWRlcnMsICcnLFxuICAgICAgICBzaWduZWRIZWFkZXJzLFxuICAgICAgICBoYXNoKHJlcXVlc3QuYm9keSwgJ2hleCcpLFxuICAgIF0uam9pbignXFxuJyk7XG5cbiAgICB2YXIgY3JlZGVudGlhbFN0cmluZyA9IFtkYXRlLCByZWdpb24sIHNlcnZpY2UsICdhd3M0X3JlcXVlc3QnXS5qb2luKCcvJyk7XG5cbiAgICB2YXIgc3RyaW5nVG9TaWduID0gW1xuICAgICAgICAnQVdTNC1ITUFDLVNIQTI1NicsXG4gICAgICAgIGRhdGV0aW1lLFxuICAgICAgICBjcmVkZW50aWFsU3RyaW5nLFxuICAgICAgICBoYXNoKGNhbm9uaWNhbFN0cmluZywgJ2hleCcpXG4gICAgXS5qb2luKCdcXG4nKTtcblxuICAgICg8SVJlcXVlc3RIZWFkZXJBdXRob3JpemF0aW9uPnJlcXVlc3QuaGVhZGVycykuQXV0aG9yaXphdGlvbiA9IFtcbiAgICAgICAgJ0FXUzQtSE1BQy1TSEEyNTYgQ3JlZGVudGlhbD0nICsgcHJvY2Vzcy5lbnYuQVdTX0FDQ0VTU19LRVlfSUQgKyAnLycgKyBjcmVkZW50aWFsU3RyaW5nLFxuICAgICAgICAnU2lnbmVkSGVhZGVycz0nICsgc2lnbmVkSGVhZGVycyxcbiAgICAgICAgJ1NpZ25hdHVyZT0nICsgaG1hYyhrU2lnbmluZywgc3RyaW5nVG9TaWduLCAnaGV4JylcbiAgICBdLmpvaW4oJywgJyk7XG5cbiAgICByZXR1cm4gcmVxdWVzdDtcbn1cblxuXG4vKipcbiAqIFRoaXMgZnVuY3Rpb24gdXNlZCB0byB3cml0ZSBmaWxlIHRvIFMzIGJ1Y2tldFxuICogQHBhcmFtIGRhdGEgXG4gKiBAcGFyYW0gYnVja2V0IFxuICogQHBhcmFtIGtleSBcbiAqL1xuIGZ1bmN0aW9uIHB1dE9iamVjdFRvUzMoZGF0YTogYW55LCBidWNrZXQ6IGFueSwga2V5OiBhbnkpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8dm9pZD4oYXN5bmMgKHJlc29sdmUpID0+IHtcbiAgICAgICAgdmFyIHMzID0gbmV3IEFXUy5TMygpO1xuICAgICAgICB2YXIgcGFyYW1zID0ge1xuICAgICAgICAgICAgQnVja2V0OiBidWNrZXQsXG4gICAgICAgICAgICBLZXk6IGtleSxcbiAgICAgICAgICAgIEJvZHk6IGRhdGFcbiAgICAgICAgfVxuICAgICAgICBhd2FpdCBzMy5wdXRPYmplY3QocGFyYW1zLCBmdW5jdGlvbiAoZXJyKSB7XG4gICAgICAgICAgICBpZiAoZXJyKSBjb25zb2xlLmxvZyhlcnIsIGVyci5zdGFjayk7IFxuICAgICAgICAgICAgZWxzZSBjb25zb2xlLmxvZyhcIlB1dCBmYWlsZWQgaW5qZWN0aW9uIGxvZ3MgdG8gczMgQnVja2V0OlwiICsgYnVja2V0ICsgXCI6XCIgKyBrZXkpOyAgICAgIFxuICAgICAgICB9KS5wcm9taXNlKCk7XG4gICAgICAgIHJlc29sdmUoKTtcbiAgICB9KTtcbn1cblxuZnVuY3Rpb24gaG1hYyhrZXk6IGFueSwgc3RyOiBhbnksIGVuY29kaW5nOiBhbnkgPSBudWxsKSB7XG4gICAgcmV0dXJuIGNyeXB0by5jcmVhdGVIbWFjKCdzaGEyNTYnLCBrZXkpLnVwZGF0ZShzdHIsICd1dGY4JykuZGlnZXN0KGVuY29kaW5nKTtcbn1cblxuZnVuY3Rpb24gaGFzaChzdHI6IGFueSwgZW5jb2Rpbmc6IGFueSkge1xuICAgIHJldHVybiBjcnlwdG8uY3JlYXRlSGFzaCgnc2hhMjU2JykudXBkYXRlKHN0ciwgJ3V0ZjgnKS5kaWdlc3QoZW5jb2RpbmcpO1xufVxuXG5mdW5jdGlvbiBidWlsZFNvdXJjZShtZXNzYWdlOiBhbnkpIHtcbiAgICB2YXIganNvblN1YlN0cmluZyA9IGV4dHJhY3RKc29uKG1lc3NhZ2UpO1xuICAgIGlmIChqc29uU3ViU3RyaW5nICE9PSBudWxsKSB7XG4gICAgICAgIHJldHVybiBKU09OLnBhcnNlKGpzb25TdWJTdHJpbmcpO1xuICAgIH1cblxuICAgIHJldHVybiB7fTtcbn1cblxuZnVuY3Rpb24gZXh0cmFjdEpzb24obWVzc2FnZTogYW55KSB7XG4gICAgbWVzc2FnZSA9IEpTT04uc3RyaW5naWZ5KG1lc3NhZ2UpO1xuICAgIHRyeSB7XG4gICAgICAgIHZhciBqc29uU3RhcnQgPSBtZXNzYWdlLmluZGV4T2YoJ3snKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdleHRyYWN0SnNvbiBlcnJvcjonLCBlKTtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgaWYgKGpzb25TdGFydCA8IDApIHJldHVybiBudWxsO1xuICAgIHZhciBqc29uU3ViU3RyaW5nID0gbWVzc2FnZS5zdWJzdHJpbmcoanNvblN0YXJ0KTtcbiAgICByZXR1cm4gaXNWYWxpZEpzb24oanNvblN1YlN0cmluZykgPyBqc29uU3ViU3RyaW5nIDogbnVsbDtcbn1cblxuZnVuY3Rpb24gaXNWYWxpZEpzb24obWVzc2FnZTogYW55KSB7XG4gICAgdHJ5IHtcbiAgICAgICAgSlNPTi5wYXJzZShtZXNzYWdlKTtcbiAgICB9IGNhdGNoIChlKSB7IHJldHVybiBmYWxzZTsgfVxuICAgIHJldHVybiB0cnVlO1xufVxuXG5mdW5jdGlvbiBsb2dGYWlsdXJlKGVycm9yOiBhbnksIGZhaWxlZEl0ZW1zOiBhbnkpIHtcbiAgICBjb25zb2xlLmxvZygnRXJyb3I6Ojo6LS0tLS0tLS0tLSAnICsgSlNPTi5zdHJpbmdpZnkoZXJyb3IsIG51bGwsIDIpKTtcblxuICAgIGlmIChmYWlsZWRJdGVtcyAmJiBmYWlsZWRJdGVtcy5sZW5ndGggPiAwKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiRmFpbGVkIEl0ZW1zOiBcIiArXG4gICAgICAgICAgICBKU09OLnN0cmluZ2lmeShmYWlsZWRJdGVtcywgbnVsbCwgMikpO1xuICAgIH1cbn1cblxuZXhwb3J0IHsgaHR0cHNSZXF1ZXN0LCBidWlsZFNvdXJjZSwgYnVpbGRSZXF1ZXN0LCBsb2dGYWlsdXJlIH0iXX0=