"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
// v1.1.3
const zlib = require("zlib");
const AWS = require("aws-sdk");
const CloudTrailWorker = require("./CloudTrailWorker");
const S3AccessWorker = require("./S3AccessWorker");
const common_1 = require("./common");
const _region = process.env.AWS_REGION;
let _workType = 'CLOUDTRAIL';
var endpoint = 'vpc-loghub-poaml2l2lbh6ssqbzadioh4gri.us-east-1.es.amazonaws.com';
const handler = async function (event, context) {
    // Get the object from the event and show its content type
    const bucket = event.Records[0].s3.bucket.name;
    const key = decodeURIComponent(event.Records[0].s3.object.key.replace(/\+/g, ' '));
    const params = {
        Bucket: bucket,
        Key: key,
    };
    switch (_workType) {
        case 'CLOUDTRAIL': {
            console.log("Get CloudTrail Log sending job.");
            await sendCloudtrail(params, context);
            break;
        }
        case 'S3ACCESS': {
            console.log("Get S3 Access Log sending job.");
            await sendS3Access(params, context);
            break;
        }
        default:
            throw new Error('Unknown work type, unable to resolve ' + _workType);
    }
};
exports.handler = handler;
/**
 * Worker for sending Amazon S3 Access logs to Amazon ES
 * @param params
 * @param context
 */
async function sendS3Access(params, context) {
    const S3 = new AWS.S3({ region: _region, apiVersion: '2006-03-01' });
    const data = await S3.getObject(params).promise();
    const s3AccessData = data.Body.toString('ascii');
    var elasticsearchBulkData = await S3AccessWorker.transform(s3AccessData);
    var requestParams = await common_1.buildRequest(endpoint, elasticsearchBulkData, _region);
    try {
        await common_1.httpsRequest(params, requestParams);
        context.succeed('Success');
    }
    catch (err) {
        console.error('POST request failed, error:', err);
        console.log('Failed transfer the log file: ', params);
        context.fail(JSON.stringify(err));
    }
    context.succeed('Success');
}
/**
 * Worker for sending Amazon CloudTrail logs which stored in S3 to Amazon ES
 * @param params
 * @param context
 */
async function sendCloudtrail(params, context) {
    if (params.Key.indexOf("CloudTrail/") != -1) {
        const S3 = new AWS.S3({ region: _region, apiVersion: '2006-03-01' });
        const data = await S3.getObject(params).promise();
        var zippedInput = await Buffer.from(data.Body, 'base64');
        const awslogsData = JSON.parse(await zlib.gunzipSync(zippedInput).toString('utf8'));
        var elasticsearchBulkData = await CloudTrailWorker.transform(awslogsData);
        var requestParams = await common_1.buildRequest(endpoint, elasticsearchBulkData, _region);
        try {
            await common_1.httpsRequest(params, requestParams);
            context.succeed('Success');
        }
        catch (err) {
            console.error('POST request failed, error:', err);
            console.log('Failed transfer the log file: ', params);
            context.fail(JSON.stringify(err));
        }
        context.succeed('Success');
    }
    else {
        console.log('Skip: The S3 object\'s key does not match CloudTrail/ formate, the key is: ', params.Key);
        context.succeed('Success');
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFFQSxTQUFTO0FBQ1QsNkJBQThCO0FBRTlCLCtCQUFnQztBQUNoQyx1REFBdUQ7QUFDdkQsbURBQW1EO0FBQ25ELHFDQUFxRDtBQUVyRCxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQztBQUN2QyxJQUFJLFNBQVMsR0FBRyxZQUFZLENBQUM7QUFFN0IsSUFBSSxRQUFRLEdBQUcsa0VBQWtFLENBQUM7QUFFbEYsTUFBTSxPQUFPLEdBQUcsS0FBSyxXQUFXLEtBQVUsRUFBRSxPQUFZO0lBQ3BELDBEQUEwRDtJQUMxRCxNQUFNLE1BQU0sR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDO0lBQy9DLE1BQU0sR0FBRyxHQUFHLGtCQUFrQixDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQ25GLE1BQU0sTUFBTSxHQUFHO1FBQ1gsTUFBTSxFQUFFLE1BQU07UUFDZCxHQUFHLEVBQUUsR0FBRztLQUNYLENBQUM7SUFDRixRQUFRLFNBQVMsRUFBRTtRQUNmLEtBQUssWUFBWSxDQUFDLENBQUM7WUFDZixPQUFPLENBQUMsR0FBRyxDQUFDLGlDQUFpQyxDQUFDLENBQUM7WUFDL0MsTUFBTSxjQUFjLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQ3RDLE1BQU07U0FDVDtRQUNELEtBQUssVUFBVSxDQUFDLENBQUM7WUFDYixPQUFPLENBQUMsR0FBRyxDQUFDLGdDQUFnQyxDQUFDLENBQUM7WUFDOUMsTUFBTSxZQUFZLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFD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LEdBQUcsQ0FBQyxDQUFDLENBQUM7U0FDckM7UUFDRCxPQUFPLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0tBRTlCO1NBQU07UUFDSCxPQUFPLENBQUMsR0FBRyxDQUFDLDZFQUE2RSxFQUFFLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN2RyxPQUFPLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0tBQzlCO0FBQ0wsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIlxuXG4vLyB2MS4xLjNcbmltcG9ydCB6bGliID0gcmVxdWlyZSgnemxpYicpO1xuXG5pbXBvcnQgQVdTID0gcmVxdWlyZSgnYXdzLXNkaycpO1xuaW1wb3J0ICogYXMgQ2xvdWRUcmFpbFdvcmtlciBmcm9tICcuL0Nsb3VkVHJhaWxXb3JrZXInO1xuaW1wb3J0ICogYXMgUzNBY2Nlc3NXb3JrZXIgZnJvbSAnLi9TM0FjY2Vzc1dvcmtlcic7XG5pbXBvcnQgeyBodHRwc1JlcXVlc3QsIGJ1aWxkUmVxdWVzdCB9IGZyb20gJy4vY29tbW9uJ1xuXG5jb25zdCBfcmVnaW9uID0gcHJvY2Vzcy5lbnYuQVdTX1JFR0lPTjtcbmxldCBfd29ya1R5cGUgPSAnQ0xPVURUUkFJTCc7XG5cbnZhciBlbmRwb2ludCA9ICd2cGMtbG9naHViLXBvYW1sMmwybGJoNnNzcWJ6YWRpb2g0Z3JpLnVzLWVhc3QtMS5lcy5hbWF6b25hd3MuY29tJztcblxuY29uc3QgaGFuZGxlciA9IGFzeW5jIGZ1bmN0aW9uIChldmVudDogYW55LCBjb250ZXh0OiBhbnkpIHtcbiAgICAvLyBHZXQgdGhlIG9iamVjdCBmcm9tIHRoZSBldmVudCBhbmQgc2hvdyBpdHMgY29udGVudCB0eXBlXG4gICAgY29uc3QgYnVja2V0ID0gZXZlbnQuUmVjb3Jkc1swXS5zMy5idWNrZXQubmFtZTtcbiAgICBjb25zdCBrZXkgPSBkZWNvZGVVUklDb21wb25lbnQoZXZlbnQuUmVjb3Jkc1swXS5zMy5vYmplY3Qua2V5LnJlcGxhY2UoL1xcKy9nLCAnICcpKTtcbiAgICBjb25zdCBwYXJhbXMgPSB7XG4gICAgICAgIEJ1Y2tldDogYnVja2V0LFxuICAgICAgICBLZXk6IGtleSxcbiAgICB9O1xuICAgIHN3aXRjaCAoX3dvcmtUeXBlKSB7XG4gICAgICAgIGNhc2UgJ0NMT1VEVFJBSUwnOiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIkdldCBDbG91ZFRyYWlsIExvZyBzZW5kaW5nIGpvYi5cIik7XG4gICAgICAgICAgICBhd2FpdCBzZW5kQ2xvdWR0cmFpbChwYXJhbXMsIGNvbnRleHQpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgY2FzZSAnUzNBQ0NFU1MnOiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIkdldCBTMyBBY2Nlc3MgTG9nIHNlbmRpbmcgam9iLlwiKTtcbiAgICAgICAgICAgIGF3YWl0IHNlbmRTM0FjY2VzcyhwYXJhbXMsIGNvbnRleHQpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVW5rbm93biB3b3JrIHR5cGUsIHVuYWJsZSB0byByZXNvbHZlICcgKyBfd29ya1R5cGUpO1xuICAgIH1cbn07XG5cbi8qKlxuICogV29ya2VyIGZvciBzZW5kaW5nIEFtYXpvbiBTMyBBY2Nlc3MgbG9ncyB0byBBbWF6b24gRVNcbiAqIEBwYXJhbSBwYXJhbXMgXG4gKiBAcGFyYW0gY29udGV4dCBcbiAqL1xuYXN5bmMgZnVuY3Rpb24gc2VuZFMzQWNjZXNzKHBhcmFtczogYW55LCBjb250ZXh0OiBhbnkpIHtcbiAgICBjb25zdCBTMyA9IG5ldyBBV1MuUzMoeyByZWdpb246IF9yZWdpb24sIGFwaVZlcnNpb246ICcyMDA2LTAzLTAxJyB9KTtcblxuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBTMy5nZXRPYmplY3QocGFyYW1zKS5wcm9taXNlKCk7XG4gICAgY29uc3QgczNBY2Nlc3NEYXRhID0gZGF0YS5Cb2R5IS50b1N0cmluZygnYXNjaWknKTtcblxuICAgIHZhciBlbGFzdGljc2VhcmNoQnVsa0RhdGEgPSBhd2FpdCBTM0FjY2Vzc1dvcmtlci50cmFuc2Zvcm0oczNBY2Nlc3NEYXRhKTtcblxuICAgIHZhciByZXF1ZXN0UGFyYW1zID0gYXdhaXQgYnVpbGRSZXF1ZXN0KGVuZHBvaW50LCBlbGFzdGljc2VhcmNoQnVsa0RhdGEsIF9yZWdpb24hKTtcblxuICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGh0dHBzUmVxdWVzdChwYXJhbXMsIHJlcXVlc3RQYXJhbXMpO1xuICAgICAgICBjb250ZXh0LnN1Y2NlZWQoJ1N1Y2Nlc3MnKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcignUE9TVCByZXF1ZXN0IGZhaWxlZCwgZXJyb3I6JywgZXJyKTtcbiAgICAgICAgY29uc29sZS5sb2coJ0ZhaWxlZCB0cmFuc2ZlciB0aGUgbG9nIGZpbGU6ICcsIHBhcmFtcyk7XG4gICAgICAgIGNvbnRleHQuZmFpbChKU09OLnN0cmluZ2lmeShlcnIpKTtcbiAgICB9XG4gICAgY29udGV4dC5zdWNjZWVkKCdTdWNjZXNzJyk7XG59XG5cbi8qKlxuICogV29ya2VyIGZvciBzZW5kaW5nIEFtYXpvbiBDbG91ZFRyYWlsIGxvZ3Mgd2hpY2ggc3RvcmVkIGluIFMzIHRvIEFtYXpvbiBFU1xuICogQHBhcmFtIHBhcmFtcyBcbiAqIEBwYXJhbSBjb250ZXh0IFxuICovXG5hc3luYyBmdW5jdGlvbiBzZW5kQ2xvdWR0cmFpbChwYXJhbXM6IGFueSwgY29udGV4dDogYW55KSB7XG4gICAgaWYgKHBhcmFtcy5LZXkuaW5kZXhPZihcIkNsb3VkVHJhaWwvXCIpICE9IC0xKSB7XG4gICAgICAgIGNvbnN0IFMzID0gbmV3IEFXUy5TMyh7IHJlZ2lvbjogX3JlZ2lvbiwgYXBpVmVyc2lvbjogJzIwMDYtMDMtMDEnIH0pO1xuICAgICAgICBjb25zdCBkYXRhID0gYXdhaXQgUzMuZ2V0T2JqZWN0KHBhcmFtcykucHJvbWlzZSgpO1xuXG4gICAgICAgIHZhciB6aXBwZWRJbnB1dCA9IGF3YWl0IEJ1ZmZlci5mcm9tKGRhdGEuQm9keSBhcyBzdHJpbmcsICdiYXNlNjQnKTtcblxuICAgICAgICBjb25zdCBhd3Nsb2dzRGF0YSA9IEpTT04ucGFyc2UoYXdhaXQgemxpYi5ndW56aXBTeW5jKHppcHBlZElucHV0KS50b1N0cmluZygndXRmOCcpKTtcblxuICAgICAgICB2YXIgZWxhc3RpY3NlYXJjaEJ1bGtEYXRhID0gYXdhaXQgQ2xvdWRUcmFpbFdvcmtlci50cmFuc2Zvcm0oYXdzbG9nc0RhdGEpO1xuXG4gICAgICAgIHZhciByZXF1ZXN0UGFyYW1zID0gYXdhaXQgYnVpbGRSZXF1ZXN0KGVuZHBvaW50LCBlbGFzdGljc2VhcmNoQnVsa0RhdGEsIF9yZWdpb24hKTtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgaHR0cHNSZXF1ZXN0KHBhcmFtcywgcmVxdWVzdFBhcmFtcyk7XG4gICAgICAgICAgICBjb250ZXh0LnN1Y2NlZWQoJ1N1Y2Nlc3MnKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCdQT1NUIHJlcXVlc3QgZmFpbGVkLCBlcnJvcjonLCBlcnIpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ0ZhaWxlZCB0cmFuc2ZlciB0aGUgbG9nIGZpbGU6ICcsIHBhcmFtcyk7XG4gICAgICAgICAgICBjb250ZXh0LmZhaWwoSlNPTi5zdHJpbmdpZnkoZXJyKSk7XG4gICAgICAgIH1cbiAgICAgICAgY29udGV4dC5zdWNjZWVkKCdTdWNjZXNzJyk7XG5cbiAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLmxvZygnU2tpcDogVGhlIFMzIG9iamVjdFxcJ3Mga2V5IGRvZXMgbm90IG1hdGNoIENsb3VkVHJhaWwvIGZvcm1hdGUsIHRoZSBrZXkgaXM6ICcsIHBhcmFtcy5LZXkpO1xuICAgICAgICBjb250ZXh0LnN1Y2NlZWQoJ1N1Y2Nlc3MnKTtcbiAgICB9XG59XG5cbmV4cG9ydCB7IGhhbmRsZXIgfSJdfQ==